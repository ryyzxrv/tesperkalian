<!DOCTYPE html>
<html lang="id" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tes Perkalian 5B - SDN Susukan 09</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Nunito', 'sans-serif'] },
                extend: {
                    colors: {
                        brand: { light: '#6366f1', dark: '#4f46e5' },
                    },
                    animation: {
                        'pulse-fast': 'pulse 0.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass {
            background: rgba(15, 23, 42, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tension-mode {
            box-shadow: inset 0 0 60px rgba(239, 68, 68, 0.4);
            border: 2px solid #ef4444 !important;
            animation: pulse-red 0.8s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: inset 0 0 30px rgba(239, 68, 68, 0.3); }
            50% { box-shadow: inset 0 0 80px rgba(239, 68, 68, 0.6); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 min-h-screen text-slate-800 dark:text-slate-100 transition-colors duration-300">

    <!-- Navbar -->
    <nav class="fixed top-0 w-full z-50 glass shadow-sm transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('/dashboard')">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b3/Logo_Tut_Wuri_Handayani.svg" alt="Logo" class="h-10 w-10 drop-shadow-md hover:scale-110 transition">
                    <div>
                        <h1 class="font-extrabold text-lg tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400">Tes Perkalian 5B</h1>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition">
                        <i class="fas fa-moon dark:hidden text-slate-600"></i>
                        <i class="fas fa-sun hidden dark:block text-yellow-400"></i>
                    </button>
                    <div id="auth-controls" class="hidden flex items-center gap-3">
                        <span id="user-display" class="hidden md:block font-bold text-sm text-indigo-600 dark:text-indigo-400"></span>
                        <button onclick="handleLogout()" class="text-xs font-bold text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg transition border border-red-200">
                            KELUAR
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="pt-24 pb-10 px-4 min-h-screen flex flex-col items-center relative overflow-hidden">
        
        <!-- Toast Notification -->
        <div id="toast" class="fixed top-24 right-5 z-[100] translate-x-full transition-transform duration-300">
            <div class="glass px-5 py-3 rounded-xl shadow-xl border-l-4 flex items-center gap-3 min-w-[300px]">
                <div id="toast-icon"></div>
                <div>
                    <h4 id="toast-title" class="font-bold text-sm">Notifikasi</h4>
                    <p id="toast-msg" class="text-xs opacity-80">Pesan disini</p>
                </div>
            </div>
        </div>

        <!-- PAGE: LOGIN (/login) -->
        <div id="page-login" class="page-section hidden w-full max-w-md animate-fade-in">
            <div class="text-center mb-8">
                <div class="inline-block p-4 rounded-full bg-white dark:bg-slate-800 shadow-xl mb-4">
                    <i class="fas fa-graduation-cap text-4xl text-indigo-600"></i>
                </div>
                <h2 class="text-3xl font-black mb-2">Selamat Datang</h2>
                <p class="text-slate-500 dark:text-slate-400">Silakan login untuk memulai tes.</p>
            </div>

            <div class="glass rounded-2xl shadow-2xl p-1 overflow-hidden">
                <div class="grid grid-cols-2 p-1 bg-slate-100 dark:bg-slate-700/50 rounded-xl mb-6 mx-6 mt-6">
                    <button onclick="setLoginRole('student')" id="btn-role-student" class="py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600">Murid</button>
                    <button onclick="setLoginRole('teacher')" id="btn-role-teacher" class="py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700">Guru</button>
                </div>

                <div class="px-8 pb-8 space-y-4">
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="login-user" placeholder="Username" class="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 focus:border-indigo-500 focus:ring-0 outline-none transition font-semibold">
                    </div>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="password" id="login-pass" placeholder="Password" class="w-full pl-10 pr-4 py-3 rounded-xl bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 focus:border-indigo-500 focus:ring-0 outline-none transition font-semibold">
                    </div>
                    <button onclick="processLogin()" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/30 transform hover:-translate-y-1 transition duration-200">
                        MASUK SEKARANG
                    </button>
                </div>
            </div>
            <p class="text-center text-xs text-slate-400 mt-8">Versi 3.0 â€¢ SD Nusantara 01</p>
        </div>

        <!-- PAGE: STUDENT DASHBOARD (/dashboard) -->
        <div id="page-dashboard" class="page-section hidden w-full max-w-5xl animate-fade-in">
            <div class="text-center mb-10">
                <span class="px-3 py-1 rounded-full bg-indigo-100 text-indigo-700 text-xs font-bold uppercase tracking-wider mb-2 inline-block">Zona Murid</span>
                <h2 class="text-3xl md:text-4xl font-black mb-2">Pilih Level Perkalian</h2>
                <p class="text-slate-500">Pilih angka perkalian untuk memulai tantangan.</p>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="level-container">
                <!-- JS will populate buttons here -->
            </div>
        </div>

        <!-- PAGE: QUIZ / GAME (/tes) -->
        <div id="page-game" class="page-section hidden w-full max-w-2xl animate-fade-in flex flex-col items-center">
            
            <!-- Header Info -->
            <div class="w-full flex justify-between items-center mb-6 px-2">
                <div class="flex items-center gap-2 text-sm font-bold text-slate-500">
                    <span class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center text-xs" id="q-index">1</span>
                    <span>/ 10 Soal</span>
                </div>
                <div id="timer-bar-container" class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="timer-bar" class="h-full bg-green-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="game-card" class="glass w-full rounded-3xl shadow-2xl p-8 md:p-10 text-center relative transition-all duration-300 border-t-4 border-indigo-500">
                <!-- Floating Timer Text -->
                <div class="absolute -top-6 left-1/2 transform -translate-x-1/2">
                    <div id="timer-text" class="w-14 h-14 bg-white dark:bg-slate-800 rounded-full shadow-lg border-4 border-slate-100 dark:border-slate-700 flex items-center justify-center font-black text-xl text-slate-700 dark:text-white">
                        15
                    </div>
                </div>

                <div class="mt-6 mb-8">
                    <h1 id="q-text" class="text-6xl font-black tracking-tight text-slate-800 dark:text-white">5 x 5</h1>
                    <p class="text-slate-400 text-sm font-medium mt-2">Pilih jawaban yang paling tepat!</p>
                </div>

                <!-- Answer Grid (4 Options) -->
                <div class="grid grid-cols-2 gap-4" id="answers-grid">
                    <!-- Buttons generated by JS -->
                </div>
            </div>
        </div>

        <!-- PAGE: TEACHER ADMIN (/guru) -->
        <div id="page-guru" class="page-section hidden w-full max-w-6xl animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-end mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-black text-slate-800 dark:text-white">Panel Guru</h2>
                    <p class="text-slate-500">Kelola data siswa dan pantau hasil belajar.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadTemplate()" class="px-4 py-2 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg text-sm font-bold hover:bg-slate-50 transition shadow-sm">
                        <i class="fas fa-download mr-2 text-indigo-500"></i>Template Excel
                    </button>
                    <label class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold transition shadow-lg shadow-green-500/30 cursor-pointer flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Upload Data
                        <input type="file" onchange="handleExcelUpload(this)" class="hidden" accept=".xlsx">
                    </label>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="glass p-6 rounded-2xl border-l-4 border-indigo-500">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Murid</p>
                    <h3 class="text-3xl font-black mt-1" id="stat-students">0</h3>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-green-500">
                    <p class="text-xs font-bold text-slate-400 uppercase">Total Tes</p>
                    <h3 class="text-3xl font-black mt-1" id="stat-tests">0</h3>
                </div>
                <div class="glass p-6 rounded-2xl border-l-4 border-red-500 cursor-pointer hover:bg-red-50 transition" onclick="resetSystem()">
                    <p class="text-xs font-bold text-red-400 uppercase">Danger Zone</p>
                    <h3 class="text-lg font-bold mt-2 text-red-600"><i class="fas fa-trash mr-2"></i>Reset Sistem</h3>
                </div>
            </div>

            <!-- Data Table -->
            <div class="glass rounded-2xl overflow-hidden shadow-lg min-h-[400px]">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-800/50 flex justify-between items-center">
                    <h4 class="font-bold">Riwayat Nilai Terbaru</h4>
                    <input type="text" id="search-table" placeholder="Cari nama..." onkeyup="filterTable()" class="px-3 py-1 text-sm rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 focus:outline-none focus:border-indigo-500">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-100 dark:bg-slate-700/50">
                            <tr>
                                <th class="px-6 py-3">Waktu</th>
                                <th class="px-6 py-3">Nama Siswa</th>
                                <th class="px-6 py-3">Level</th>
                                <th class="px-6 py-3 text-center">Nilai</th>
                                <th class="px-6 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="divide-y divide-slate-200 dark:divide-slate-700">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
                <div id="empty-data-msg" class="hidden p-10 text-center text-slate-400">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>Belum ada data tes masuk.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /* --- CONFIGURATION --- */
        const APP_CONFIG = {
            adminUser: "Pak Tanjung",
            adminPass: "guru",
            dbStudents: "db_students_v3",
            dbResults: "db_results_v3",
            timeLimit: 15 // seconds
        };

        /* --- STATE MANAGEMENT --- */
        let state = {
            user: null, // {name, role, username}
            game: {
                active: false,
                level: 1,
                qIndex: 0,
                score: 0,
                questions: [], // [{q: "5x5", a: 25, options: [24,25,26,30]}]
                timer: null,
                timeLeft: 0
            }
        };

        /* --- ROUTING SYSTEM (Virtual Router) --- */
        const routes = {
            '/login': 'page-login',
            '/dashboard': 'page-dashboard',
            '/guru': 'page-guru',
            '/tes': 'page-game'
        };

        function initRouter() {
            // Handle browser Back/Forward
            window.addEventListener('popstate', (event) => {
                const path = window.location.pathname;
                renderPage(path === '/' ? '/login' : path);
            });

            // Initial Load
            const path = window.location.pathname === '/' ? '/login' : window.location.pathname;
            
            // Basic Guard: If trying to access /dashboard or /guru without auth, redirect
            if ((path === '/dashboard' || path === '/guru' || path === '/tes') && !state.user) {
                navigateTo('/login', true);
            } else {
                renderPage(path);
            }
        }

        function navigateTo(path, replace = false) {
            if (replace) {
                history.replaceState({}, "", path);
            } else {
                history.pushState({}, "", path);
            }
            renderPage(path);
        }

        function renderPage(path) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('hidden'));
            
            // Normalize path for /tes/...
            let viewId = routes[path];
            if (path.startsWith('/tes')) viewId = 'page-game';
            
            const target = document.getElementById(viewId || 'page-login');
            if(target) {
                target.classList.remove('hidden');
                // Page specific init
                if(viewId === 'page-guru') loadAdminPanel();
                if(viewId === 'page-dashboard') renderLevelButtons();
            }
        }

        /* --- AUTHENTICATION --- */
        let selectedRole = 'student'; // Default

        function setLoginRole(role) {
            selectedRole = role;
            const btnStd = document.getElementById('btn-role-student');
            const btnTea = document.getElementById('btn-role-teacher');
            const inputUser = document.getElementById('login-user');

            if(role === 'student') {
                btnStd.className = "py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600";
                btnTea.className = "py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
                inputUser.placeholder = "Username Murid";
                inputUser.value = "";
            } else {
                btnTea.className = "py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600";
                btnStd.className = "py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
                inputUser.placeholder = "Username Guru";
                inputUser.value = "Pak Tanjung"; // Auto fill for demo
            }
        }

        function processLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();

            if (selectedRole === 'teacher') {
                if (u === APP_CONFIG.adminUser && p === APP_CONFIG.adminPass) {
                    state.user = { name: "Pak Tanjung", role: "admin" };
                    showToast("Login Berhasil", `Selamat datang, ${state.user.name}`, "success");
                    updateAuthUI();
                    navigateTo('/guru');
                } else {
                    showToast("Login Gagal", "Username atau Password salah!", "error");
                    document.getElementById('page-login').classList.add('animate-shake');
                    setTimeout(() => document.getElementById('page-login').classList.remove('animate-shake'), 500);
                }
            } else {
                const students = JSON.parse(localStorage.getItem(APP_CONFIG.dbStudents) || "[]");
                // Default dummy student if empty
                if (students.length === 0 && u === 'murid' && p === '123') {
                    // Inject temp student
                    students.push({name: "Murid Demo", user: "murid", pass: "123"});
                    localStorage.setItem(APP_CONFIG.dbStudents, JSON.stringify(students));
                }

                const found = students.find(s => s.user === u && s.pass == p); // Loose equality for pass
                if (found) {
                    state.user = { name: found.name, role: "student", username: found.user };
                    showToast("Login Berhasil", `Semangat belajar, ${found.name}!`, "success");
                    updateAuthUI();
                    navigateTo('/dashboard');
                } else {
                    showToast("Akun Tidak Ditemukan", "Hubungi Pak Tanjung untuk daftar.", "error");
                }
            }
        }

        function handleLogout() {
            state.user = null;
            state.game.active = false;
            clearInterval(state.game.timer);
            updateAuthUI();
            navigateTo('/login');
        }

        function updateAuthUI() {
            const controls = document.getElementById('auth-controls');
            const userDisplay = document.getElementById('user-display');
            if (state.user) {
                controls.classList.remove('hidden');
                userDisplay.innerText = state.user.name;
            } else {
                controls.classList.add('hidden');
            }
        }

        /* --- GAME ENGINE (DISTRACTOR LOGIC) --- */
        function renderLevelButtons() {
            const container = document.getElementById('level-container');
            container.innerHTML = '';
            for(let i=1; i<=20; i++) {
                const btn = document.createElement('button');
                btn.className = "glass h-24 rounded-2xl flex flex-col items-center justify-center gap-1 hover:scale-105 hover:bg-white transition-all shadow-md group border border-transparent hover:border-indigo-300";
                btn.onclick = () => startGame(i);
                btn.innerHTML = `
                    <span class="text-xs font-bold text-slate-400 group-hover:text-indigo-500">LEVEL</span>
                    <span class="text-3xl font-black text-slate-700 dark:text-white group-hover:text-indigo-600">x${i}</span>
                `;
                container.appendChild(btn);
            }
        }

        function generateDistractors(correctAnswer, multiplier) {
            let options = new Set();
            options.add(correctAnswer);

            // Strategy 1: Close numbers (+1, -1)
            options.add(correctAnswer + 1);
            options.add(correctAnswer - 1);
            
            // Strategy 2: Trap answer (e.g. 6x7=42, trap could be 6+7=13 or 67 or 76 or nearby multiple)
            options.add(correctAnswer + 10);
            options.add(correctAnswer - 5);
            options.add(correctAnswer + multiplier); 

            // Convert to array and filter negative or duplicates
            let arr = Array.from(options).filter(n => n > 0 && Number.isInteger(n));
            
            // If we don't have enough, fill with random close numbers
            while(arr.length < 4) {
                let randomOffset = Math.floor(Math.random() * 10) - 5;
                let val = correctAnswer + randomOffset;
                if(val > 0 && !arr.includes(val)) arr.push(val);
            }

            // Shuffle
            return arr.slice(0, 4).sort(() => Math.random() - 0.5);
        }

        function startGame(level) {
            state.game.active = true;
            state.game.level = level;
            state.game.score = 0;
            state.game.qIndex = 0;
            state.game.questions = [];

            // Generate 10 questions
            for(let i=0; i<10; i++) {
                let m = Math.floor(Math.random() * 10) + 1;
                // Occasionally flip (3x5 vs 5x3)
                let text = Math.random() > 0.5 ? `${level} x ${m}` : `${m} x ${level}`;
                let ans = level * m;
                state.game.questions.push({
                    text: text,
                    answer: ans,
                    options: generateDistractors(ans, level)
                });
            }

            navigateTo(`/tes/perkalian-${level}`);
            loadQuestion();
        }

        function loadQuestion() {
            if (state.game.qIndex >= 10) {
                endGame();
                return;
            }

            const q = state.game.questions[state.game.qIndex];
            
            // UI Update
            document.getElementById('q-index').innerText = state.game.qIndex + 1;
            document.getElementById('q-text').innerText = q.text;
            
            // Timer Reset
            resetTimerStyles();
            startTimer();

            // Render Options
            const grid = document.getElementById('answers-grid');
            grid.innerHTML = '';
            
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "py-6 rounded-xl bg-white dark:bg-slate-800 shadow-md border-b-4 border-slate-200 dark:border-slate-700 hover:border-indigo-500 hover:bg-indigo-50 dark:hover:bg-slate-700 text-2xl font-bold transition-all active:scale-95 text-slate-700 dark:text-white";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(opt);
                grid.appendChild(btn);
            });
        }

        function startTimer() {
            clearInterval(state.game.timer);
            state.game.timeLeft = APP_CONFIG.timeLimit;
            updateTimerUI();

            state.game.timer = setInterval(() => {
                state.game.timeLeft--;
                updateTimerUI();

                if (state.game.timeLeft <= 0) {
                    clearInterval(state.game.timer);
                    handleAnswer(-999); // Timeout
                }
            }, 1000);
        }

        function updateTimerUI() {
            const t = state.game.timeLeft;
            const card = document.getElementById('game-card');
            const timerText = document.getElementById('timer-text');
            const bar = document.getElementById('timer-bar');

            timerText.innerText = t;
            bar.style.width = `${(t / APP_CONFIG.timeLimit) * 100}%`;

            if (t <= 5) {
                card.classList.add('tension-mode');
                timerText.classList.add('text-red-500', 'border-red-500');
                bar.className = "h-full bg-red-500 transition-all duration-1000 ease-linear";
            }
        }

        function resetTimerStyles() {
            const card = document.getElementById('game-card');
            const timerText = document.getElementById('timer-text');
            const bar = document.getElementById('timer-bar');

            card.classList.remove('tension-mode');
            timerText.className = "w-14 h-14 bg-white dark:bg-slate-800 rounded-full shadow-lg border-4 border-slate-100 dark:border-slate-700 flex items-center justify-center font-black text-xl text-slate-700 dark:text-white";
            bar.className = "h-full bg-green-500 transition-all duration-1000 ease-linear";
        }

        function handleAnswer(val) {
            clearInterval(state.game.timer);
            const correct = state.game.questions[state.game.qIndex].answer;
            
            if (val === correct) {
                state.game.score += 10;
                confetti({ particleCount: 20, spread: 40, origin: { y: 0.8 }, colors: ['#6366f1', '#22c55e'] });
            } else {
                // Shake effect on card
                document.getElementById('game-card').classList.add('animate-shake');
                setTimeout(() => document.getElementById('game-card').classList.remove('animate-shake'), 500);
            }

            state.game.qIndex++;
            setTimeout(loadQuestion, 500); // Quick delay
        }

        function endGame() {
            // Save Result
            const results = JSON.parse(localStorage.getItem(APP_CONFIG.dbResults) || "[]");
            results.push({
                student: state.user.name,
                level: state.game.level,
                score: state.game.score,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem(APP_CONFIG.dbResults, JSON.stringify(results));

            if(state.game.score >= 80) {
                 confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
            }

            alert(`Tes Selesai!\nNilai: ${state.game.score}`);
            navigateTo('/dashboard');
        }

        /* --- ADMIN & EXCEL --- */
        function loadAdminPanel() {
            const students = JSON.parse(localStorage.getItem(APP_CONFIG.dbStudents) || "[]");
            const results = JSON.parse(localStorage.getItem(APP_CONFIG.dbResults) || "[]");

            document.getElementById('stat-students').innerText = students.length;
            document.getElementById('stat-tests').innerText = results.length;

            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = '';
            
            if(results.length === 0) {
                document.getElementById('empty-data-msg').classList.remove('hidden');
            } else {
                document.getElementById('empty-data-msg').classList.add('hidden');
                results.reverse().forEach(r => {
                    const date = new Date(r.timestamp).toLocaleString('id-ID');
                    const statusClass = r.score >= 70 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                    const statusText = r.score >= 70 ? 'LULUS' : 'REMEDIAL';
                    
                    tbody.innerHTML += `
                        <tr class="bg-white dark:bg-slate-800 hover:bg-slate-50 transition border-b dark:border-slate-700">
                            <td class="px-6 py-4 font-mono text-xs text-slate-400">${date}</td>
                            <td class="px-6 py-4 font-bold">${r.student}</td>
                            <td class="px-6 py-4">Level x${r.level}</td>
                            <td class="px-6 py-4 text-center font-bold text-lg">${r.score}</td>
                            <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded text-xs font-bold ${statusClass}">${statusText}</span></td>
                        </tr>
                    `;
                });
            }
        }

        function downloadTemplate() {
            const ws = XLSX.utils.json_to_sheet([
                { "Nama": "Budi Santoso", "Username": "budi01", "Password": "123" },
                { "Nama": "Siti Aminah", "Username": "siti02", "Password": "456" }
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Murid");
            XLSX.writeFile(wb, "Template_Data_Murid.xlsx");
        }

        function handleExcelUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                
                const newStudents = json.map(row => ({
                    name: row["Nama"], user: row["Username"], pass: row["Password"]
                })).filter(s => s.user && s.pass);

                const current = JSON.parse(localStorage.getItem(APP_CONFIG.dbStudents) || "[]");
                localStorage.setItem(APP_CONFIG.dbStudents, JSON.stringify([...current, ...newStudents]));
                showToast("Upload Berhasil", `${newStudents.length} siswa ditambahkan.`, "success");
                loadAdminPanel();
            };
            reader.readAsArrayBuffer(file);
        }

        function resetSystem() {
            if(confirm("HAPUS SEMUA DATA?")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        /* --- UTILS --- */
        function showToast(title, msg, type) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            document.getElementById('toast-msg').innerText = msg;
            
            const icon = document.getElementById('toast-icon');
            icon.innerHTML = type === 'success' 
                ? '<i class="fas fa-check-circle text-2xl text-green-500"></i>' 
                : '<i class="fas fa-exclamation-circle text-2xl text-red-500"></i>';
            
            toast.querySelector('.glass').classList.add(type === 'success' ? 'border-green-500' : 'border-red-500');
            
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
        }

        // --- INIT APP ---
        document.addEventListener('DOMContentLoaded', initRouter);

    </script>
</body>
</html>
